(this["webpackJsonpimage-annotation"]=this["webpackJsonpimage-annotation"]||[]).push([[0],{14:function(e,t,n){},16:function(e,t,n){"use strict";n.r(t);var r=n(1),i=n(5),c=n.n(i),a=n(0),o=(n(14),n(2));var s=e=>{const{currentTool:t,onSelectTool:n,onClear:r,onUndo:i,onExport:c,historyLength:a,strokeColor:s,lineWidth:l,onColorChange:h,onLineWidthChange:u}=e;return Object(o.jsxs)("div",{className:"toolbar",children:[Object(o.jsxs)("div",{className:"brush-controls",children:[Object(o.jsx)("label",{htmlFor:"color-picker",children:"\u989c\u8272:"}),Object(o.jsx)("input",{id:"color-picker",type:"color",value:s,onChange:e=>h(e.target.value),style:{marginRight:"10px"}}),Object(o.jsx)("label",{htmlFor:"line-width",children:"\u7ebf\u5bbd:"}),Object(o.jsx)("input",{id:"line-width",type:"range",min:"1",max:"10",value:l,onChange:e=>u(Number(e.target.value))}),Object(o.jsxs)("span",{children:[l,"px"]})]}),Object(o.jsx)("button",{className:"rectangle"===t?"active":"",onClick:()=>n("rectangle"),children:"\u77e9\u5f62"}),Object(o.jsx)("button",{className:"circle"===t?"active":"",onClick:()=>n("circle"),children:"\u5706\u5f62"}),Object(o.jsx)("button",{className:"arrow"===t?"active":"",onClick:()=>n("arrow"),children:"\u7bad\u5934"}),Object(o.jsx)("button",{className:"text"===t?"active":"",onClick:()=>n("text"),children:"\u6587\u5b57"}),Object(o.jsx)("button",{className:"freehand"===t?"active":"",onClick:()=>n("freehand"),children:"\u81ea\u7531\u7ebf\u6761"}),Object(o.jsx)("button",{onClick:r,style:{marginLeft:"20px",background:"#ff4d4f",color:"white"},children:"\u6e05\u9664\u6240\u6709"}),Object(o.jsx)("button",{onClick:i,disabled:0===a,style:{marginLeft:"10px"},children:"\u4e0a\u4e00\u6b65 (Ctrl+Z)"}),Object(o.jsx)("button",{onClick:c,style:{marginLeft:"10px"},children:"\u5bfc\u51fa"})]})};const l="16px Arial",h=(e,t)=>{const n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}},u=(e,t)=>{if("rectangle"===e.type)return{x:e.x,y:e.y,width:e.width,height:e.height};if("circle"===e.type)return{x:e.x-e.radius,y:e.y-e.radius,width:2*e.radius,height:2*e.radius};if("arrow"===e.type){const t=Math.min(e.x,e.x+e.width),n=Math.min(e.y,e.y+e.height);return{x:t,y:n,width:Math.max(e.x,e.x+e.width)-t,height:Math.max(e.y,e.y+e.height)-n}}if("text"===e.type){const{width:n,height:r}=((e,t)=>{e.font=l;const n=t.split("\n");let r=0;for(let i=0;i<n.length;i++){const t=e.measureText(n[i]);r=Math.max(r,t.width)}return{width:r,height:20*n.length}})(t,e.text);return{x:e.x,y:e.y-20,width:n,height:r}}return{x:0,y:0,width:0,height:0}},d=function(e,t,n,r,i,c){let a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:6;const o=i-n,s=c-r,l=o*o+s*s;let h,u,d=-1;0!==l&&(d=((e-n)*o+(t-r)*s)/l),d<0?(h=n,u=r):d>1?(h=i,u=c):(h=n+d*o,u=r+d*s);const b=e-h,x=t-u;return Math.sqrt(b*b+x*x)<a},b=(e,t,n,r)=>{if("rectangle"===e.type){const r=2;return Math.abs(t-e.x)<=r&&n>=e.y&&n<=e.y+e.height||Math.abs(t-(e.x+e.width))<=r&&n>=e.y&&n<=e.y+e.height||Math.abs(n-e.y)<=r&&t>=e.x&&t<=e.x+e.width||Math.abs(n-(e.y+e.height))<=r&&t>=e.x&&t<=e.x+e.width}if("circle"===e.type){const r=Math.sqrt((t-e.x)**2+(n-e.y)**2);return Math.abs(r-e.radius)<=2}if("arrow"===e.type)return d(t,n,e.x,e.y,e.x+e.width,e.y+e.height);if("text"===e.type){const i=u(e,r);return t>=i.x&&t<=i.x+i.width&&n>=i.y&&n<=i.y+i.height}if("freehand"===e.type){for(let r=0;r<e.points.length-1;r++){const i=e.points[r],c=e.points[r+1];if(d(t,n,i.x,i.y,c.x,c.y))return!0}return!1}return!1},x=e=>"freehand"===(null===e||void 0===e?void 0:e.type)&&Array.isArray(e.points)?Object(a.a)(Object(a.a)({},e),{},{points:e.points.map(e=>({x:e.x,y:e.y}))}):Object(a.a)({},e);n(4);const y=Object(r.forwardRef)((e,t)=>{const{annotations:n,ctxRef:i,canvasRef:c,defaultColor:s}=e,[h,u]=Object(r.useState)({visible:!1,position:{x:0,y:0},value:"",id:null,width:200,height:24}),d=Object(r.useRef)(null),b=Object(r.useRef)(null),x=Object(r.useMemo)(()=>s,[s]),y=Object(r.useCallback)(()=>{if(!i.current||!c.current)return;i.current.font=l;let e=200,t=24;if(h.id){const r=n.find(e=>e.id===h.id);if(null!==r&&void 0!==r&&r.text){const n=r.text.split("\n");t=Math.max(24,20*n.length),e=Math.max(200,...n.map(e=>i.current?i.current.measureText(e).width:0))+10}}const r=Math.max(0,Math.min(h.position.x,c.current.width-e)),o=Math.max(16,Math.min(h.position.y,c.current.height-t));u(Object(a.a)(Object(a.a)({},h),{},{position:{x:r,y:o},width:e,height:t}))},[h,n,i,c]),f=Object(r.useCallback)(e=>{if(!i.current||!c.current)return;const t=e.target.value,n=t.split("\n");let r=0,o=0;n.forEach(e=>{const t=i.current.measureText(e);o=Math.max(o,t.width),r+=20}),u(e=>Object(a.a)(Object(a.a)({},e),{},{value:t,width:o+10,height:Math.min(r,c.current.height-e.position.y-10)}))},[i,c]),g=Object(r.useCallback)(e=>{if("Enter"!==e.key||!e.shiftKey)return"Escape"===e.key?(e.preventDefault(),void u(e=>Object(a.a)(Object(a.a)({},e),{},{visible:!1,value:""}))):void("Enter"===e.key&&(e.preventDefault(),u(e=>Object(a.a)(Object(a.a)({},e),{},{visible:!1,value:e.value.trim()?e.value:""}))))},[]);return Object(r.useImperativeHandle)(t,()=>({getText:()=>h,setText:u}),[h]),Object(r.useEffect)(()=>{h.visible&&y()},[h.visible,h.id,y]),Object(r.useEffect)(()=>(d.current&&h.visible&&(b.current&&window.clearTimeout(b.current),b.current=window.setTimeout(()=>{d.current&&d.current.focus()},200)),()=>{b.current&&window.clearTimeout(b.current)}),[h.position,h.visible]),Object(o.jsx)(o.Fragment,{children:h.visible?Object(o.jsx)("textarea",{id:"textInput",ref:d,className:"text-input",value:h.value,style:{left:h.position.x,top:h.position.y,width:h.width,height:h.height,color:x},onChange:f,onKeyDown:g}):null})});var f=Object(r.memo)(y);const g=(e,t,n)=>{const{fromX:r,fromY:i,toX:c,toY:a,color:o}=t;if(Math.abs(c-r)<5&&Math.abs(a-i)<5)return;const s=Math.atan2(a-i,c-r);e.strokeStyle=o,e.lineWidth=n,e.beginPath(),e.moveTo(r,i),e.lineTo(c,a),e.stroke(),e.beginPath(),e.moveTo(c,a),e.lineTo(c-15*Math.cos(s-Math.PI/6),a-15*Math.sin(s-Math.PI/6)),e.moveTo(c,a),e.lineTo(c-15*Math.cos(s+Math.PI/6),a-15*Math.sin(s+Math.PI/6)),e.stroke()},j=(e,t,n)=>{e.strokeStyle=t.color,e.lineWidth=n,e.beginPath(),e.arc(t.x,t.y,t.radius,0,2*Math.PI),e.stroke()},O=(e,t,n)=>{if(t.points.length){e.strokeStyle=t.color,e.lineWidth=n,e.beginPath(),e.moveTo(t.points[0].x,t.points[0].y);for(let n=1;n<t.points.length;n++)e.lineTo(t.points[n].x,t.points[n].y);e.stroke()}},p=(e,t,n)=>{e.strokeStyle=t.color,e.lineWidth=n,e.strokeRect(t.x,t.y,t.width,t.height)},v=function(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"#FF0000",i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"#FFFFFF";e.fillStyle=i,e.strokeStyle=r,e.beginPath(),e.arc(t,n,5,0,2*Math.PI),e.fill(),e.stroke()};var m=e=>{let{src:t}=e;const n=Object(r.useRef)(0),i=Object(r.useCallback)(()=>"".concat(Date.now(),"-").concat(n.current++),[]),[c,l]=Object(r.useState)({isDrawing:!1,isDragging:!1,startPos:{x:0,y:0},currentPos:{x:0,y:0},freehandPath:[],selectedId:null}),[u,d]=Object(r.useState)([]),[y,m]=Object(r.useState)([]),[w,k]=Object(r.useState)(null),[M,C]=Object(r.useState)("#FF0000"),[P,T]=Object(r.useState)(2),I=Object(r.useRef)(null),D=Object(r.useRef)(null),E=Object(r.useRef)(null),R=Object(r.useRef)(null),S=Object(r.useRef)(null),F=Object(r.useCallback)(()=>{m(e=>[...e,u.map(x)])},[u]),W=()=>{if(y.length>0){const e=y[y.length-1];m(e=>e.slice(0,-1)),d(e),l(e=>Object(a.a)(Object(a.a)({},e),{},{selectedId:null}))}},L=Object(r.useCallback)(()=>{c.selectedId&&(F(),d(e=>e.filter(e=>e.id!==c.selectedId)),l(e=>Object(a.a)(Object(a.a)({},e),{},{selectedId:null})))},[c.selectedId,F]);Object(r.useEffect)(()=>{const e=I.current;if(!e)return;e.width=800,e.height=600,S.current=e.getContext("2d");const n=new Image;n.crossOrigin="Anonymous",n.src=t,n.onload=()=>{D.current=n,N()};const r=()=>{const t=e.parentElement;if(t&&D.current){const n=D.current.width/D.current.height,r=t.clientWidth;e.style.width="".concat(Math.min(r,D.current.width),"px"),e.style.height="".concat(Math.min(r/n,D.current.height),"px")}};return window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[t]);const A=Object(r.useCallback)(()=>{const e=I.current,t=S.current;if(!e||!t||!D.current)return;const n=Math.min(800/D.current.naturalWidth,600/D.current.naturalHeight),r=D.current.naturalWidth*n,i=D.current.naturalHeight*n,c=(800-r)/2,a=(600-i)/2;t.drawImage(D.current,c,a,r,i),e.dataset.scale="".concat(n),e.dataset.offsetX="".concat(c),e.dataset.offsetY="".concat(a)},[]),N=Object(r.useCallback)(()=>{const e=I.current,t=S.current;if(!e||!t)return;const{startPos:n,currentPos:r,isDrawing:i,selectedId:o,freehandPath:s}=c;R.current&&cancelAnimationFrame(R.current),R.current=requestAnimationFrame(()=>{t.clearRect(0,0,e.width,e.height);const c=M,l=P;if(A(),u.forEach(e=>{switch(e.type){case"rectangle":p(t,e,e.lineWidth||l);break;case"circle":j(t,e,e.lineWidth||l);break;case"arrow":g(t,Object(a.a)(Object(a.a)({},e),{},{fromX:e.x,fromY:e.y,toX:e.x+e.width,toY:e.y+e.height}),e.lineWidth||l);break;case"text":{var n;const r=null===(n=E.current)||void 0===n?void 0:n.getText();if(null!==r&&void 0!==r&&r.visible&&r.id===e.id)return;((e,t)=>{e.fillStyle=t.color,e.font="16px Arial";const n=t.text.split("\n");let r=t.y;for(let i=0;i<n.length;i++)e.fillText(n[i],t.x,r),r+=20})(t,e);break}case"freehand":O(t,e,e.lineWidth||l)}if(e.id===o&&"freehand"!==e.type&&"text"!==e.type){const n=((e,t)=>{if("rectangle"===e.type)return{x:e.x,y:e.y,width:e.width,height:e.height};if("circle"===e.type)return{x:e.x-e.radius,y:e.y-e.radius,width:2*e.radius,height:2*e.radius};if("arrow"===e.type){const t=Math.min(e.x,e.x+e.width),n=Math.min(e.y,e.y+e.height);return{x:t,y:n,width:Math.max(e.x,e.x+e.width)-t,height:Math.max(e.y,e.y+e.height)-n}}if("text"===e.type){t.font="16px Arial";const n=e.text.split("\n"),r=20,i=n.length*r;let c=0;for(let e=0;e<n.length;e++){const r=t.measureText(n[e]);c=Math.max(c,r.width)}return{x:e.x,y:e.y-r,width:c,height:i}}return{x:0,y:0,width:0,height:0}})(e,t);"arrow"===e.type?(v(t,e.x,e.y),v(t,e.x+e.width,e.y+e.height)):(t.setLineDash([3,3]),t.strokeStyle="#1890ff",t.strokeRect(n.x,n.y,n.width,n.height),t.setLineDash([]),v(t,n.x,n.y),v(t,n.x+n.width,n.y),v(t,n.x+n.width,n.y+n.height),v(t,n.x,n.y+n.height))}}),i&&w){const e=r.x-n.x,i=r.y-n.y;switch(w){case"rectangle":p(t,{type:"rectangle",x:n.x,y:n.y,width:e,height:i,color:c},l);break;case"circle":{const r=Math.sqrt(e**2+i**2);j(t,{type:"circle",x:n.x,y:n.y,radius:r,color:c},l);break}case"arrow":g(t,{fromX:n.x,fromY:n.y,toX:r.x,toY:r.y,color:c},l);break;case"freehand":O(t,{type:"freehand",points:s,color:c},l)}}})},[u,c,w,M,P,A]),X=Object(r.useCallback)(e=>{const t=I.current,n=S.current;if(!t||!n)return;const{startPos:r,currentPos:i,isDragging:o,isDrawing:s,selectedId:x,freehandPath:y}=c,{x:f,y:g}=h(e,t),j=u.some(e=>b(e,f,g,n));if(t.style.cursor=j?"move":"crosshair",o&&x){const e=f-i.x,t=g-i.y;return d(n=>n.map(n=>n.id===x?"freehand"===n.type?Object(a.a)(Object(a.a)({},n),{},{points:n.points.map(n=>({x:n.x+e,y:n.y+t}))}):Object(a.a)(Object(a.a)({},n),{},{x:n.x+e,y:n.y+t}):n)),l(Object(a.a)(Object(a.a)({},c),{},{currentPos:{x:f,y:g}})),void N()}s&&(l(Object(a.a)(Object(a.a)({},c),{},{freehandPath:"freehand"===w?[...y,{x:f,y:g}]:y,currentPos:{x:f,y:g}})),N())},[c,w,u,N]),Y=Object(r.useMemo)(()=>function(e,t){let n=0;return function(){const r=(new Date).getTime();if(r-n>=t){for(var i=arguments.length,c=new Array(i),a=0;a<i;a++)c[a]=arguments[a];e.apply(this,c),n=r}}}(X,50),[X]);return Object(r.useEffect)(()=>{const{selectedId:e,isDragging:t,isDrawing:n}=c;t&&n||N();const r=I.current;r&&(r.style.cursor=e?"move":"crosshair")},[u,c.isDragging,c.isDrawing,c.selectedId,N]),Object(r.useEffect)(()=>{c.selectedId&&"freehand"!==w&&l(Object(a.a)(Object(a.a)({},c),{},{selectedId:null}))},[w]),Object(r.useEffect)(()=>{const e=e=>{var t;const n=null===(t=E.current)||void 0===t?void 0:t.getText();if("text"!==w||null===n||void 0===n||!n.visible)if("Delete"===e.key)L();else if(e.ctrlKey&&"z"===e.key)W();else if("Escape"===e.key){var r;if("text"===w&&null!==n&&void 0!==n&&n.visible)null===(r=E.current)||void 0===r||r.setText(Object(a.a)(Object(a.a)({},n),{},{visible:!1}))}};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e),R.current&&cancelAnimationFrame(R.current)}},[L,W,w]),Object(o.jsxs)("div",{children:[Object(o.jsx)(s,{currentTool:w,onSelectTool:k,onClear:()=>{F(),d([]),l(Object(a.a)(Object(a.a)({},c),{},{selectedId:null}))},onUndo:W,onExport:()=>{const e=I.current;e&&((e,t)=>{const n=e.toDataURL("image/png"),r=document.createElement("a");r.href=n,r.download="".concat(t||"annotated_image.png"),r.click(),r.remove()})(e)},historyLength:y.length,strokeColor:M,lineWidth:P,onColorChange:C,onLineWidthChange:T}),Object(o.jsxs)("div",{className:"image-container",children:[Object(o.jsx)("canvas",{ref:I,onMouseDown:e=>{if(2===e.detail||2===e.button||!w)return;const t=I.current,n=S.current;if(!t||!n)return;const{x:r,y:o}=h(e,t);if(!u.filter(e=>"text"===e.type).some(e=>b(e,r,o,n))){var s;const e=null===(s=E.current)||void 0===s?void 0:s.getText();if("text"===w){var x;if(null!==e&&void 0!==e&&e.visible)if(e.value&&e.value.trim()){var y;const t=e.id||i();d(n=>[...n,{id:t,type:"text",x:e.position.x,y:e.position.y+16,text:e.value,color:M}]),null===(y=E.current)||void 0===y||y.setText(Object(a.a)(Object(a.a)({},e),{},{id:t,visible:!1})),F()}else{var f;null===(f=E.current)||void 0===f||f.setText(e=>Object(a.a)(Object(a.a)({},e),{},{position:{x:r,y:o}}))}else null===(x=E.current)||void 0===x||x.setText(e=>Object(a.a)(Object(a.a)({},e),{},{visible:!0,position:{x:r,y:o},value:"",id:null}));return}var g;(null===e||void 0===e?void 0:e.visible)&&(null===(g=E.current)||void 0===g||g.setText(Object(a.a)(Object(a.a)({},e),{},{visible:!1})))}const j=[...u].reverse().find(e=>b(e,r,o,n));l(Object(a.a)(Object(a.a)({},c),{},{startPos:{x:r,y:o},currentPos:{x:r,y:o},freehandPath:"freehand"===w?[{x:r,y:o}]:[],selectedId:(null===j||void 0===j?void 0:j.id)||null,isDragging:!!j,isDrawing:!j}))},onMouseMove:Y,onMouseUp:()=>{const{startPos:e,currentPos:t,isDrawing:n,isDragging:r,freehandPath:o}=c;if(n&&r||!w)return;if(r)return F(),void l(Object(a.a)(Object(a.a)({},c),{},{isDragging:!1,isDrawing:!1}));const s=t.x-e.x,h=t.y-e.y;if(["rectangle","circle","arrow","freehand"].includes(w)&&(Math.abs(s)>3||Math.abs(h)>3)){F();const t="freehand"===w?{points:[...o]}:{},n="circle"===w?{radius:Math.sqrt(s**2+h**2)}:{},r=Object(a.a)(Object(a.a)({id:i(),type:w,x:e.x,y:e.y,width:s,height:h,color:M,lineWidth:P},t),n);o.length>0&&l(Object(a.a)(Object(a.a)({},c),{},{freehandPath:[]})),d(e=>[...e,r])}l({selectedId:c.selectedId,freehandPath:[],startPos:{x:0,y:0},currentPos:{x:0,y:0},isDrawing:!1,isDragging:!1})},onContextMenu:()=>{c.selectedId&&l(Object(a.a)(Object(a.a)({},c),{},{selectedId:null}))}}),Object(o.jsx)(f,{ref:E,annotations:u,defaultColor:M,ctxRef:S,canvasRef:I})]})]})};const w=document.getElementById("app");if(!w)throw new Error("Root element not found in DOM");c.a.createRoot(w).render(Object(o.jsx)(m,{src:"https://img1.baa.bitautotech.com/dzusergroupfiles/2024/11/06/e2a4e9bb9e854429bed46ba1e343b47a.jpg"}))},4:function(e,t,n){}},[[16,1,2]]]);