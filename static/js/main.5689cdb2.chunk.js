(this["webpackJsonpimage-annotation"]=this["webpackJsonpimage-annotation"]||[]).push([[0],{14:function(e,t,n){},16:function(e,t,n){"use strict";n.r(t);var i=n(1),r=n(5),c=n.n(r),a=n(0),o=(n(14),n(2));var s=e=>{const{currentTool:t,onSelectTool:n,onClear:i,onUndo:r,onExport:c,historyLength:a,strokeColor:s,lineWidth:l,onColorChange:h,onLineWidthChange:u}=e;return Object(o.jsxs)("div",{className:"toolbar",children:[Object(o.jsxs)("div",{className:"brush-controls",children:[Object(o.jsx)("label",{htmlFor:"color-picker",children:"\u989c\u8272:"}),Object(o.jsx)("input",{id:"color-picker",type:"color",value:s,onChange:e=>h(e.target.value),style:{marginRight:"10px"}}),Object(o.jsx)("label",{htmlFor:"line-width",children:"\u7ebf\u5bbd:"}),Object(o.jsx)("input",{id:"line-width",type:"range",min:"1",max:"10",value:l,onChange:e=>u(Number(e.target.value))}),Object(o.jsxs)("span",{children:[l,"px"]})]}),Object(o.jsx)("button",{className:"rectangle"===t?"active":"",onClick:()=>n("rectangle"),children:"\u77e9\u5f62"}),Object(o.jsx)("button",{className:"circle"===t?"active":"",onClick:()=>n("circle"),children:"\u5706\u5f62"}),Object(o.jsx)("button",{className:"arrow"===t?"active":"",onClick:()=>n("arrow"),children:"\u7bad\u5934"}),Object(o.jsx)("button",{className:"text"===t?"active":"",onClick:()=>n("text"),children:"\u6587\u5b57"}),Object(o.jsx)("button",{className:"freehand"===t?"active":"",onClick:()=>n("freehand"),children:"\u81ea\u7531\u7ebf\u6761"}),Object(o.jsx)("button",{onClick:i,style:{marginLeft:"20px",background:"#ff4d4f",color:"white"},children:"\u6e05\u9664\u6240\u6709"}),Object(o.jsx)("button",{onClick:r,disabled:0===a,style:{marginLeft:"10px"},children:"\u4e0a\u4e00\u6b65 (Ctrl+Z)"}),Object(o.jsx)("button",{onClick:c,style:{marginLeft:"10px"},children:"\u5bfc\u51fa"})]})};const l="16px Arial",h=(e,t)=>{const n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}},u=(e,t)=>{if("rectangle"===e.type)return{x:e.x,y:e.y,width:e.width,height:e.height};if("circle"===e.type)return{x:e.x-e.radius,y:e.y-e.radius,width:2*e.radius,height:2*e.radius};if("arrow"===e.type){const t=Math.min(e.x,e.x+e.width),n=Math.min(e.y,e.y+e.height);return{x:t,y:n,width:Math.max(e.x,e.x+e.width)-t,height:Math.max(e.y,e.y+e.height)-n}}if("text"===e.type){const{width:n,height:i}=((e,t)=>{e.font=l;const n=t.split("\n");let i=0;for(let r=0;r<n.length;r++){const t=e.measureText(n[r]);i=Math.max(i,t.width)}return{width:i,height:20*n.length}})(t,e.text);return{x:e.x,y:e.y-20,width:n,height:i}}return{x:0,y:0,width:0,height:0}},d=function(e,t,n,i,r,c){let a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:6;const o=r-n,s=c-i,l=o*o+s*s;let h,u,d=-1;0!==l&&(d=((e-n)*o+(t-i)*s)/l),d<0?(h=n,u=i):d>1?(h=r,u=c):(h=n+d*o,u=i+d*s);const b=e-h,x=t-u;return Math.sqrt(b*b+x*x)<a},b=(e,t,n,i)=>{if("rectangle"===e.type){const i=2;return Math.abs(t-e.x)<=i&&n>=e.y&&n<=e.y+e.height||Math.abs(t-(e.x+e.width))<=i&&n>=e.y&&n<=e.y+e.height||Math.abs(n-e.y)<=i&&t>=e.x&&t<=e.x+e.width||Math.abs(n-(e.y+e.height))<=i&&t>=e.x&&t<=e.x+e.width}if("circle"===e.type){const i=Math.sqrt((t-e.x)**2+(n-e.y)**2);return Math.abs(i-e.radius)<=2}if("arrow"===e.type)return d(t,n,e.x,e.y,e.x+e.width,e.y+e.height);if("text"===e.type){const r=u(e,i);return t>=r.x&&t<=r.x+r.width&&n>=r.y&&n<=r.y+r.height}if("freehand"===e.type){for(let i=0;i<e.points.length-1;i++){const r=e.points[i],c=e.points[i+1];if(d(t,n,r.x,r.y,c.x,c.y))return!0}return!1}return!1},x=e=>"freehand"===(null===e||void 0===e?void 0:e.type)&&Array.isArray(e.points)?Object(a.a)(Object(a.a)({},e),{},{points:e.points.map(e=>({x:e.x,y:e.y}))}):Object(a.a)({},e);n(4);const f=Object(i.forwardRef)((e,t)=>{const{annotations:n,ctxRef:r,canvasRef:c,defaultColor:s}=e,[h,u]=Object(i.useState)({visible:!1,position:{x:0,y:0},value:"",id:null,width:200,height:24}),d=Object(i.useRef)(null),b=Object(i.useRef)(null),x=Object(i.useMemo)(()=>s,[s]),f=Object(i.useCallback)(()=>{if(!r.current||!c.current)return;r.current.font=l;let e=200,t=24;if(h.id){const i=n.find(e=>e.id===h.id);if(null!==i&&void 0!==i&&i.text){const n=i.text.split("\n");t=Math.max(24,20*n.length),e=Math.max(200,...n.map(e=>r.current?r.current.measureText(e).width:0))+10}}const i=Math.max(0,Math.min(h.position.x,c.current.width-e)),o=Math.max(16,Math.min(h.position.y,c.current.height-t));u(Object(a.a)(Object(a.a)({},h),{},{position:{x:i,y:o},width:e,height:t}))},[h,n,r,c]),g=Object(i.useCallback)(e=>{if(!r.current||!c.current)return;const t=e.target.value,n=t.split("\n");let i=0,o=0;n.forEach(e=>{const t=r.current.measureText(e);o=Math.max(o,t.width),i+=20}),u(e=>Object(a.a)(Object(a.a)({},e),{},{value:t,width:o+10,height:Math.min(i,c.current.height-e.position.y-10)}))},[r,c]),y=Object(i.useCallback)(e=>{if("Enter"!==e.key||!e.shiftKey)return"Escape"===e.key?(e.preventDefault(),void u(e=>Object(a.a)(Object(a.a)({},e),{},{visible:!1,value:""}))):void("Enter"===e.key&&(e.preventDefault(),u(e=>Object(a.a)(Object(a.a)({},e),{},{visible:!1,value:e.value.trim()?e.value:""}))))},[]);return Object(i.useImperativeHandle)(t,()=>({getText:()=>h,setText:u}),[h]),Object(i.useEffect)(()=>{h.visible&&f()},[h.visible,h.id,f]),Object(i.useEffect)(()=>(d.current&&h.visible&&(b.current&&window.clearTimeout(b.current),b.current=window.setTimeout(()=>{d.current&&d.current.focus()},200)),()=>{b.current&&window.clearTimeout(b.current)}),[h.position,h.visible]),Object(o.jsx)(o.Fragment,{children:h.visible?Object(o.jsx)("textarea",{id:"textInput",ref:d,className:"text-input",value:h.value,style:{left:h.position.x,top:h.position.y,width:h.width,height:h.height,color:x},onChange:g,onKeyDown:y}):null})});var g=Object(i.memo)(f);const y=function(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"#FF0000",r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"#FFFFFF";e.fillStyle=r,e.strokeStyle=i,e.beginPath(),e.arc(t,n,5,0,2*Math.PI),e.fill(),e.stroke()};var j=e=>{let{src:t}=e;const n=Object(i.useRef)(0),r=Object(i.useCallback)(()=>"".concat(Date.now(),"-").concat(n.current++),[]),[c,l]=Object(i.useState)({isDrawing:!1,isDragging:!1,startPos:{x:0,y:0},currentPos:{x:0,y:0},freehandPath:[],selectedId:null}),[u,d]=Object(i.useState)([]),[f,j]=Object(i.useState)([]),[O,v]=Object(i.useState)(null),[p,m]=Object(i.useState)("#FF0000"),[w,M]=Object(i.useState)(2),k=Object(i.useRef)(null),C=Object(i.useRef)(null),P=Object(i.useRef)(null),T=Object(i.useRef)(null),I=Object(i.useRef)(null),D=Object(i.useCallback)(()=>{j(e=>[...e,u.map(x)])},[u]),E=()=>{if(f.length>0){const e=f[f.length-1];j(e=>e.slice(0,-1)),d(e),l(e=>Object(a.a)(Object(a.a)({},e),{},{selectedId:null}))}},R=Object(i.useCallback)(()=>{c.selectedId&&(D(),d(e=>e.filter(e=>e.id!==c.selectedId)),l(e=>Object(a.a)(Object(a.a)({},e),{},{selectedId:null})))},[c.selectedId,D]);Object(i.useEffect)(()=>{const e=k.current;if(!e)return;e.width=800,e.height=600,I.current=e.getContext("2d");const n=new Image;n.crossOrigin="Anonymous",n.src=t,n.onload=()=>{C.current=n,F()};const i=()=>{const t=e.parentElement;if(t&&C.current){const n=C.current.width/C.current.height,i=t.clientWidth;e.style.width="".concat(Math.min(i,C.current.width),"px"),e.style.height="".concat(Math.min(i/n,C.current.height),"px")}};return window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[t]);const S=Object(i.useCallback)(()=>{const e=k.current,t=I.current;if(!e||!t||!C.current)return;const n=Math.min(800/C.current.naturalWidth,600/C.current.naturalHeight),i=C.current.naturalWidth*n,r=C.current.naturalHeight*n,c=(800-i)/2,a=(600-r)/2;t.drawImage(C.current,c,a,i,r),e.dataset.scale="".concat(n),e.dataset.offsetX="".concat(c),e.dataset.offsetY="".concat(a)},[]),F=Object(i.useCallback)(()=>{const e=k.current,t=I.current;if(!e||!t)return;const{startPos:n,currentPos:i,isDrawing:r,selectedId:o,freehandPath:s}=c;T.current&&cancelAnimationFrame(T.current),T.current=requestAnimationFrame(()=>{t.clearRect(0,0,e.width,e.height);const n=w;S(),u.forEach(e=>{switch(e.type){case"rectangle":((e,t,n)=>{e.strokeStyle=t.color,e.lineWidth=n,e.strokeRect(t.x,t.y,t.width,t.height)})(t,e,e.lineWidth||n);break;case"circle":((e,t,n)=>{e.strokeStyle=t.color,e.lineWidth=n,e.beginPath(),e.arc(t.x,t.y,t.radius,0,2*Math.PI),e.stroke()})(t,e,e.lineWidth||n);break;case"arrow":((e,t,n)=>{const{fromX:i,fromY:r,toX:c,toY:a,color:o}=t;if(Math.abs(c-i)<5&&Math.abs(a-r)<5)return;const s=Math.atan2(a-r,c-i);e.strokeStyle=o,e.lineWidth=n,e.beginPath(),e.moveTo(i,r),e.lineTo(c,a),e.stroke(),e.beginPath(),e.moveTo(c,a),e.lineTo(c-15*Math.cos(s-Math.PI/6),a-15*Math.sin(s-Math.PI/6)),e.moveTo(c,a),e.lineTo(c-15*Math.cos(s+Math.PI/6),a-15*Math.sin(s+Math.PI/6)),e.stroke()})(t,Object(a.a)(Object(a.a)({},e),{},{fromX:e.x,fromY:e.y,toX:e.x+e.width,toY:e.y+e.height}),e.lineWidth||n);break;case"text":{var i;const n=null===(i=P.current)||void 0===i?void 0:i.getText();if(null!==n&&void 0!==n&&n.visible&&n.id===e.id)return;((e,t)=>{e.fillStyle=t.color,e.font="16px Arial";const n=t.text.split("\n");let i=t.y;for(let r=0;r<n.length;r++)e.fillText(n[r],t.x,i),i+=20})(t,e);break}case"freehand":((e,t,n)=>{if(t.points.length){e.strokeStyle=t.color,e.lineWidth=n,e.beginPath(),e.moveTo(t.points[0].x,t.points[0].y);for(let n=1;n<t.points.length;n++)e.lineTo(t.points[n].x,t.points[n].y);e.stroke()}})(t,e,e.lineWidth||n)}if(e.id===o&&"freehand"!==e.type&&"text"!==e.type){const n=((e,t)=>{if("rectangle"===e.type)return{x:e.x,y:e.y,width:e.width,height:e.height};if("circle"===e.type)return{x:e.x-e.radius,y:e.y-e.radius,width:2*e.radius,height:2*e.radius};if("arrow"===e.type){const t=Math.min(e.x,e.x+e.width),n=Math.min(e.y,e.y+e.height);return{x:t,y:n,width:Math.max(e.x,e.x+e.width)-t,height:Math.max(e.y,e.y+e.height)-n}}if("text"===e.type){t.font="16px Arial";const n=e.text.split("\n"),i=20,r=n.length*i;let c=0;for(let e=0;e<n.length;e++){const i=t.measureText(n[e]);c=Math.max(c,i.width)}return{x:e.x,y:e.y-i,width:c,height:r}}return{x:0,y:0,width:0,height:0}})(e,t);"arrow"===e.type?(y(t,e.x,e.y),y(t,e.x+e.width,e.y+e.height)):(t.setLineDash([3,3]),t.strokeStyle="#1890ff",t.strokeRect(n.x,n.y,n.width,n.height),t.setLineDash([]),y(t,n.x,n.y),y(t,n.x+n.width,n.y),y(t,n.x+n.width,n.y+n.height),y(t,n.x,n.y+n.height))}})})},[u,c,O,p,w,S]),W=Object(i.useCallback)(e=>{const t=k.current,n=I.current;if(!t||!n)return;const{startPos:i,currentPos:r,isDragging:o,isDrawing:s,selectedId:x,freehandPath:f}=c,{x:g,y:y}=h(e,t),j=u.some(e=>b(e,g,y,n));if(t.style.cursor=j?"move":"crosshair",o&&x){const e=g-r.x,t=y-r.y;return d(n=>n.map(n=>n.id===x?"freehand"===n.type?Object(a.a)(Object(a.a)({},n),{},{points:n.points.map(n=>({x:n.x+e,y:n.y+t}))}):Object(a.a)(Object(a.a)({},n),{},{x:n.x+e,y:n.y+t}):n)),l(Object(a.a)(Object(a.a)({},c),{},{currentPos:{x:g,y:y}})),void F()}s&&(l(Object(a.a)(Object(a.a)({},c),{},{freehandPath:"freehand"===O?[...f,{x:g,y:y}]:f,currentPos:{x:g,y:y}})),F())},[c,O,u,F]),L=Object(i.useMemo)(()=>function(e,t){let n=0;return function(){const i=(new Date).getTime();if(i-n>=t){for(var r=arguments.length,c=new Array(r),a=0;a<r;a++)c[a]=arguments[a];e.apply(this,c),n=i}}}(W,50),[W]);return Object(i.useEffect)(()=>{const{selectedId:e,isDragging:t,isDrawing:n}=c;t&&n||F();const i=k.current;i&&(i.style.cursor=e?"move":"crosshair")},[u,c.isDragging,c.isDrawing,c.selectedId,F]),Object(i.useEffect)(()=>{c.selectedId&&"freehand"!==O&&l(Object(a.a)(Object(a.a)({},c),{},{selectedId:null}))},[O]),Object(i.useEffect)(()=>{const e=e=>{var t;const n=null===(t=P.current)||void 0===t?void 0:t.getText();if("text"!==O||null===n||void 0===n||!n.visible)if("Delete"===e.key)R();else if(e.ctrlKey&&"z"===e.key)E();else if("Escape"===e.key){var i;if("text"===O&&null!==n&&void 0!==n&&n.visible)null===(i=P.current)||void 0===i||i.setText(Object(a.a)(Object(a.a)({},n),{},{visible:!1}))}};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e),T.current&&cancelAnimationFrame(T.current)}},[R,E,O]),Object(o.jsxs)("div",{children:[Object(o.jsx)(s,{currentTool:O,onSelectTool:v,onClear:()=>{D(),d([]),l(Object(a.a)(Object(a.a)({},c),{},{selectedId:null}))},onUndo:E,onExport:()=>{const e=k.current;e&&((e,t)=>{const n=e.toDataURL("image/png"),i=document.createElement("a");i.href=n,i.download="".concat(t||"annotated_image.png"),i.click(),i.remove()})(e)},historyLength:f.length,strokeColor:p,lineWidth:w,onColorChange:m,onLineWidthChange:M}),Object(o.jsxs)("div",{className:"image-container",children:[Object(o.jsx)("canvas",{ref:k,onMouseDown:e=>{if(2===e.detail||2===e.button||!O)return;const t=k.current,n=I.current;if(!t||!n)return;const{x:i,y:o}=h(e,t);if(!u.filter(e=>"text"===e.type).some(e=>b(e,i,o,n))){var s;const e=null===(s=P.current)||void 0===s?void 0:s.getText();if("text"===O){var x;if(null!==e&&void 0!==e&&e.visible)if(e.value&&e.value.trim()){var f;const t=e.id||r();d(n=>[...n,{id:t,type:"text",x:e.position.x,y:e.position.y+16,text:e.value,color:p}]),null===(f=P.current)||void 0===f||f.setText(Object(a.a)(Object(a.a)({},e),{},{id:t,visible:!1})),D()}else{var g;null===(g=P.current)||void 0===g||g.setText(e=>Object(a.a)(Object(a.a)({},e),{},{position:{x:i,y:o}}))}else null===(x=P.current)||void 0===x||x.setText(e=>Object(a.a)(Object(a.a)({},e),{},{visible:!0,position:{x:i,y:o},value:"",id:null}));return}var y;(null===e||void 0===e?void 0:e.visible)&&(null===(y=P.current)||void 0===y||y.setText(Object(a.a)(Object(a.a)({},e),{},{visible:!1})))}const j=[...u].reverse().find(e=>b(e,i,o,n));l(Object(a.a)(Object(a.a)({},c),{},{startPos:{x:i,y:o},currentPos:{x:i,y:o},freehandPath:"freehand"===O?[{x:i,y:o}]:[],selectedId:(null===j||void 0===j?void 0:j.id)||null,isDragging:!!j,isDrawing:!j}))},onMouseMove:L,onMouseUp:()=>{const{startPos:e,currentPos:t,isDrawing:n,isDragging:i,freehandPath:o}=c;if(n&&i||!O)return;if(i)return D(),void l(Object(a.a)(Object(a.a)({},c),{},{isDragging:!1,isDrawing:!1}));const s=t.x-e.x,h=t.y-e.y;if(["rectangle","circle","arrow","freehand"].includes(O)&&(Math.abs(s)>3||Math.abs(h)>3)){D();const t="freehand"===O?{points:[...o]}:{},n="circle"===O?{radius:Math.sqrt(s**2+h**2)}:{},i=Object(a.a)(Object(a.a)({id:r(),type:O,x:e.x,y:e.y,width:s,height:h,color:p,lineWidth:w},t),n);o.length>0&&l(Object(a.a)(Object(a.a)({},c),{},{freehandPath:[]})),d(e=>[...e,i])}l({selectedId:c.selectedId,freehandPath:[],startPos:{x:0,y:0},currentPos:{x:0,y:0},isDrawing:!1,isDragging:!1})},onContextMenu:()=>{c.selectedId&&l(Object(a.a)(Object(a.a)({},c),{},{selectedId:null}))}}),Object(o.jsx)(g,{ref:P,annotations:u,defaultColor:p,ctxRef:I,canvasRef:k})]})]})};const O=document.getElementById("app");if(!O)throw new Error("Root element not found in DOM");c.a.createRoot(O).render(Object(o.jsx)(j,{src:"https://img1.baa.bitautotech.com/dzusergroupfiles/2024/11/06/e2a4e9bb9e854429bed46ba1e343b47a.jpg"}))},4:function(e,t,n){}},[[16,1,2]]]);